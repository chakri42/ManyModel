 {
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
 
 "parameters": {
    "suffixName": {
            "defaultValue": "z25",
            "minLength": 3,
            "maxLength": 10,
            "type": "String",
            "metadata": {
                "description": "Name the suffix between 3-10 characters with only characters and numbers"
            }
        },
    "AllowAll": {
      "type": "string",
      "allowedValues": [
        "true",
        "false"
      ],
      "defaultValue": "false",
      "metadata": {
        "description": "Allow connections from all IP addresses to your workspace's endpoints. You can restrict these permissions to just Azure datacenter IP addresses and/or specific IP address ranges after creating the workspace."
      }
    }
  },

  "variables": {
    "location": "[resourceGroup().location]",
    "rgId": "[resourceGroup().id]",
    "paramName": "[variables('uniqueName')]",
    "storageContainer": "input",
    "storageContainer2": "output",
    "uniqueName": "[substring(uniqueString(variables('rgId')),0,4)]",
    "synapseWorkspaceName": "[concat('synapse-ws-',variables('paramName'))]",
    "storageName": "[replace(replace(toLower(concat(concat('synapsestrg',variables('paramName')),variables('uniqueName'))),'-',''),'_','')]"
    },
    
    "resources": [
    {
      "type": "Microsoft.Storage/storageAccounts",
      "apiVersion": "2019-06-01",
      "name": "[variables('storageName')]",
      "location": "[variables('location')]",
      "sku": {
        "name": "Standard_LRS",
        "tier": "Standard"
      },
      "kind": "StorageV2",
      "properties": {
        "isHnsEnabled": true,
        "networkAcls": {
          "bypass": "AzureServices",
          "virtualNetworkRules": [],
          "ipRules": [],
          "defaultAction": "Allow"
        },
        "supportsHttpsTrafficOnly": true,
        "encryption": {
          "services": {
            "file": {
              "enabled": true
            },
            "blob": {
              "enabled": true
            }
          },
          "keySource": "Microsoft.Storage"
        },
        "accessTier": "Hot"
      }
    },
    {
      "type": "Microsoft.Storage/storageAccounts/blobServices",
      "apiVersion": "2019-06-01",
      "name": "[concat(variables('storageName'), '/default')]",
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts', variables('storageName'))]"
      ],
      "properties": {
        "cors": {
          "corsRules": []
        },
        "deleteRetentionPolicy": {
          "enabled": false
        }
      }
    },
    {
      "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
      "apiVersion": "2019-06-01",
      "name": "[concat(variables('storageName'), '/default/', variables('storageContainer'))]",
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts/blobServices', variables('storageName'), 'default')]",
        "[resourceId('Microsoft.Storage/storageAccounts', variables('storageName'))]"
      ],
      "properties": {
        "publicAccess": "Container"
      }
    },
    {
      "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
      "apiVersion": "2019-06-01",
      "name": "[concat(variables('storageName'), '/default/', variables('storageContainer2'))]",
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts/blobServices', variables('storageName'), 'default')]",
        "[resourceId('Microsoft.Storage/storageAccounts', variables('storageName'))]"
      ],
      "properties": {
        "publicAccess": "Container"
      }
    },
     {
      "type": "Microsoft.Synapse/workspaces",
      "apiVersion": "2021-06-01",
      "name": "[variables('synapseWorkspaceName')]",
      "location": "[variables('location')]",
      "identity": {
        "type": "SystemAssigned"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts/blobServices', variables('storageName'), 'default')]",
        "[resourceId('Microsoft.Storage/storageAccounts', variables('storageName'))]"
      ],
      "properties": {
        "defaultDataLakeStorage": {
          "accountUrl": "[concat('https://', variables('storageName') , '.dfs.core.windows.net')]",
          "filesystem": "[variables('storageContainer')]"
        },
        "virtualNetworkProfile": {
          "computeSubnetId": ""
        },
        "sqlAdministratorLogin": "sqladminuser"
      },
      "resources": [
        {
          "condition": "[equals(parameters('AllowAll'),'true')]",
          "type": "firewallrules",
          "apiVersion": "2021-06-01",
          "name": "ipaddress",
          "location": "[variables('location')]",
          "dependsOn": [ "[variables('synapseWorkspaceName')]" ],
          "properties": {
            "startIpAddress": "0.0.0.0",
            "endIpAddress": "255.255.255.255"
          }
        }
      ]
    },
    {
      "type": "Microsoft.Synapse/workspaces/bigDataPools",
      "apiVersion": "2021-06-01",
      "name": "[concat(variables('synapseWorkspaceName'), '/spark1')]",
      "location": "[variables('location')]",
      "dependsOn": [
        "[resourceId('Microsoft.Synapse/workspaces', variables('synapseWorkspaceName'))]"
      ],
      "properties": {
        "sparkVersion": "2.4",
        "nodeCount": 3,
        "nodeSize": "Medium",
        "nodeSizeFamily": "MemoryOptimized",
        "autoScale": {
          "enabled": true,
          "minNodeCount": 3,
          "maxNodeCount": 6
        },
        "autoPause": {
          "enabled": true,
          "delayInMinutes": 15
        },
        "isComputeIsolationEnabled": false,
        "sessionLevelPackagesEnabled": false,
        "cacheSize": 0,
        "dynamicExecutorAllocation": {
          "enabled": true
        }
      }
    },
    {
      "type": "Microsoft.Synapse/workspaces/sqlPools",
      "apiVersion": "2020-12-01",
      "name": "[concat(variables('synapseWorkspaceName'), '/sqlpool1')]",
      "location": "[variables('location')]",
      "dependsOn": [
        "[resourceId('Microsoft.Synapse/workspaces',  variables('synapseWorkspaceName'))]"
      ],
      "sku": {
        "name": "DW100c",
        "capacity": 0
      },
      "properties": {
        "status": "Paused",
        "maxSizeBytes": 263882790666240,
        "collation": "SQL_Latin1_General_CP1_CI_AS",
        "restorePointInTime": "0001-01-01T00:00:00",
        "creationDate": "2021-04-01T21:06:42.853Z",
        "storageAccountType": "GRS",
        "provisioningState": "Succeeded"
      }
    },
   
  {
      "apiVersion": "2020-10-01",
      "name": "pid-cde9ebb2-7587-5acb-9601-d0887a5a4fd2",
      "type": "Microsoft.Resources/deployments",
      "properties": {
        "mode": "Incremental",
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "resources": []
        }
      }
    }
  ]
 }
